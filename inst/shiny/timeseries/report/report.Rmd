---
title: "Report"
output:
  html_document:
    fig_width: 12
    fig_height: 10
params:
  run_as_standalone: TRUE
  report_data: NA
  report_sitenames: NA
  report_parameters: NA
  report_daterange: NA
  report_timezone: NA
---

```{r, echo=FALSE, results='hide', message=FALSE, warning=FALSE}
library(ggplot2)
library(ggforce)
library(aquanes.report)


if (params$run_as_standalone) {
  
### Raw data
dat <- readRDS("C:/Users/mrustl/Desktop/Github_aquanes.report/trunk/inst/shiny/timeseries/data/haridwar_raw_list.Rds")


input <- list(report_sitenames = unique(dat$SiteName),
              report_parameters = unique(dat$ParameterName)[1:10],
              report_daterange = c("2016-09-01", "2016-09-30"),
              report_timezone = "UTC")


date_idx <- as.Date(dat[,"DateTime"]) >= input$report_daterange[1] & as.Date(dat[,"DateTime"]) <= input$report_daterange[2]
site_idx <- dat[,"SiteName"] %in% input$report_sitenames
para_idx <- dat[,"ParameterName"] %in%  input$report_parameters
row_idx <- date_idx & site_idx & para_idx


config <- list(run_as_standalone = TRUE,
               report_data = aquanes.report::change_timezone(dat[row_idx,],tz = input$report_timezone), 
               report_sitenames = input$report_sitenames,
               report_parameters = input$report_parameters,
               report_daterange = input$report_daterange,
               report_timezone = input$report_timezone
               )
} else {
 config <- list(run_as_standalone = params$run_as_standalone,
                report_data = params$report_data,
                report_sitenames = params$report_sitenames,
                report_parameters = params$report_parameters,
                report_daterange = params$report_daterange,
                report_timezone = params$report_timezone)
}

```

#General 
Here is the ggplot2 output from `r config$report_daterange[1]` to  `r config$report_daterange[2]`
using the timezone "`r config$report_timezone`".

**You selected the following `r length(config$report_parameters)` parameter(s) for plotting:**

`r paste("* ", config$report_parameters,collapse = "  \n")`


**At the following `r length(config$report_sitenames)` sampling location(s):**

`r paste("* ", config$report_sitenames,collapse = "  \n")`



```{r, fig.width=12, fig.height=7, echo=FALSE}

    for (i in seq_along(unique(config$report_data[,"ParameterName"]))) {
    
    g1 <- ggplot2::ggplot(config$report_data, ggplot2::aes_string(x = "DateTime",
                                    y = "ParameterValue",
                                    col = "SiteName")) +
      ggforce::facet_wrap_paginate("sprintf('%s (%s)',ParameterName, ParameterUnit)",
                                   nrow = 1,
                                   ncol = 1,
                                   scales = "free_y",
                                   page = i) +
      ggplot2::geom_point() +
      ggplot2::theme_bw() +
      ggplot2::theme(legend.position = "top")
     print(g1) 
    }
```

